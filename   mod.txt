Attribute VB_Name = "Module9"

Function FindHeaderCol(ws As Worksheet, header As String) As Long
    Dim rng As Range
    Set rng = ws.Rows(2).Find(What:=header, LookIn:=xlValues, LookAt:=xlWhole, MatchCase:=False)
    If Not rng Is Nothing Then
        FindHeaderCol = rng.Column
    Else
        FindHeaderCol = 0 ' Return 0 if the header is not found
    End If
End Function

Function FindHeaderRow(ws As Worksheet, header As String) As Long
    Dim rng As Range
    Set rng = ws.Columns(1).Find(What:=header, LookIn:=xlValues, LookAt:=xlWhole, MatchCase:=False)
    If Not rng Is Nothing Then
        FindHeaderRow = rng.row
    Else
        FindHeaderRow = 0 ' Return 0 if the header is not found
    End If
End Function

Function IsSectionHeader(header As String) As Boolean
    Select Case header
        Case "Over 90 Days", "Accrual", "Non-Accrual"
            IsSectionHeader = True
        Case Else
            IsSectionHeader = False
    End Select
End Function


Sub MoveNonAccrualLoansToBottom()
    Dim ws As Worksheet, wsT As Worksheet
    Dim lastRow As Long, lasTrowT As Long
    Dim nextRow As Long
    Dim i As Long
    Dim colNonAccrual As Long
    Dim nonAccrualValue As Variant

    ' Set the worksheet
    Set ws = ThisWorkbook.Worksheets("Pursuit-CDC")
    If ws Is Nothing Then
        MsgBox "Sectioned Data worksheet not found!"
        Exit Sub
    End If
    
     Set wsT = ThisWorkbook.Worksheets("Non-Accrual - $0")
    If wsT Is Nothing Then
        MsgBox "Non-Accrual worksheet not found!"
        Exit Sub
    End If

    ' Get the last row in the worksheet
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row
     lasTrowT = wsT.Cells(wsT.Rows.Count, "A").End(xlUp).row

    ' Find the column for "Non-Accrual"
    colNonAccrual = FindHeaderCol(ws, "Non-Accrual")
    If colNonAccrual = 0 Then
        MsgBox "Non-Accrual column not found!"
        Exit Sub
    End If

    ' Initialize the row counter for the "Non-Accrual" section
    nextRow = lastRow + 2

    ' Add the "Non-Accrual" header
   ' ws.Cells(nextRow, 1).Value = "Non-Accrual"
    'ws.Cells(nextRow, 1).Font.Bold = True
    'ws.Cells(nextRow, 1).Font.Underline = xlUnderlineStyleSingle
    'nextRow = nextRow + 1
    
    AddSectionHeader ws, "Non-Accrual", nextRow
    ' Loop through the data in reverse order
    For i = lastRow To 2 Step -1 ' Assuming headers are in the first row
        nonAccrualValue = ws.Cells(i, colNonAccrual).Value

        ' Check if the loan has a Non-Accrual status of 1 or 2
        If nonAccrualValue = 1 Or nonAccrualValue = 2 Then
            ' Copy the row to the "Non-Accrual" section
            ws.Rows(i).Copy Destination:=ws.Rows(nextRow)
            
            ' Delete the original row
            ws.Rows(i).Delete
        End If
    Next i
    
      ' DO the same for wsT
    ' Resetting column for branches
    colNonAccrual = FindHeaderCol(wsT, "Non-Accrual")
    If colNonAccrual = 0 Then
        MsgBox "Non-Accrual column for Specialty programs not found!"
        Exit Sub
    End If
    
    ' re- initializing row counter for specialty ws
    nextRow = lasTrowT + 2
    Module1.AddSectionHeaderNA wsT, "Non-Accrual", nextRow
    'Looping in reverse
    For i = lasTrowT To 2 Step -1
        nonAccrualValue = wsT.Cells(i, colNonAccrual).Value
        ' check if loan has non-acrual status of 1 or 2
        If nonAccrualValue = 1 Or nonAccrualValue = 2 Then
            ' copy rows to non-accrual section
            wsT.Rows(i).Copy Destination:=wsT.Rows(nextRow)
            'delete old
            wsT.Rows(i).Delete
        End If
    Next i
    
    

    ' Autofit columns
    ws.Columns.AutoFit
    wsT.Columns.AutoFit

 '   MsgBox "Non-Accrual loans have been moved successfully!"
End Sub



Sub AddSectionHeader(ws As Worksheet, sectionName As String, ByRef nextRow As Long)
    ws.Cells(nextRow, 1).Value = sectionName
    ws.Cells(nextRow, 1).Font.Bold = True
    ws.Cells(nextRow, 1).Font.Underline = xlUnderlineStyleSingle

    nextRow = nextRow + 1

   
    ws.Cells(nextRow, 1).Value = "Company Name"
    ws.Cells(nextRow, 2).Value = "Loan Nbr"
    ws.Cells(nextRow, 3).Value = "Next Payment Due Date"
    ws.Cells(nextRow, 4).Value = "Note Date"
    ws.Cells(nextRow, 5).Value = "Principal"
    ws.Cells(nextRow, 6).Value = "Charge-Off $"
    ws.Cells(nextRow, 7).Value = "Charge-Off Date"
    ws.Cells(nextRow, 8).Value = "Risk Factor"
    ws.Cells(nextRow, 9).Value = "Maturity Date"
    ws.Cells(nextRow, 10).Value = "Int Paid to Date"
    ws.Cells(nextRow, 11).Value = "Non-Accrual"
    ws.Cells(nextRow, 12).Value = "SBA Gty%"
    ws.Cells(nextRow, 13).Value = "Participant"
    ws.Cells(nextRow, 14).Value = "Amount Past Due"
    ws.Cells(nextRow, 15).Value = "Special Asset Analyst"
    ws.Cells(nextRow, 16).Value = "Site Visit Date"
     ws.Cells(nextRow, 17).Value = "Non-Accrual Date"
    ws.Rows(nextRow).Font.Bold = True


    nextRow = nextRow + 1

End Sub
